---
- name: Install Grafana via package manager (preferred)
  block:
    - name: Import Grafana GPG key (idempotent)
      rpm_key:
        state: present
        key: https://packages.grafana.com/gpg.key

    - name: Add Grafana repo
      copy:
        dest: /etc/yum.repos.d/grafana.repo
        content: |
          [grafana]
          name=Grafana OSS
          baseurl=https://packages.grafana.com/oss/rpm
          repo_gpgcheck=1
          enabled=1
          gpgcheck=1
          gpgkey=https://packages.grafana.com/gpg.key
          sslverify=1
          sslcacert=/etc/pki/tls/certs/ca-bundle.crt

    - name: Install Grafana (dnf with retries)
      dnf:
        name: grafana
        state: present
        update_cache: yes
      register: grafana_pkg
      retries: 3
      delay: 15
      until: grafana_pkg is succeeded

  rescue:
    - name: Fallback | Create grafana user
      user:
        name: grafana
        system: yes
        shell: /sbin/nologin
      changed_when: false

    - name: Fallback | Create directories
      file:
        path: "{{ item }}"
        state: directory
        owner: grafana
        group: grafana
        mode: '0755'
      loop:
        - /opt
        - /etc/grafana
        - /var/lib/grafana

    - name: Fallback | Download Grafana tarball
      get_url:
        url: https://dl.grafana.com/oss/release/grafana-10.4.3.linux-amd64.tar.gz
        dest: /var/tmp/grafana.tar.gz
        mode: '0644'

    - name: Fallback | Extract tarball to /opt
      unarchive:
        src: /var/tmp/grafana.tar.gz
        dest: /opt
        remote_src: yes

    - name: Fallback | Symlink /opt/grafana to extracted directory
      file:
        src: "/opt/grafana-10.4.3"
        dest: /opt/grafana
        state: link

    - name: Fallback | Ensure ownership of grafana dirs
      file:
        path: "{{ item }}"
        state: directory
        owner: grafana
        group: grafana
        recurse: yes
      loop:
        - /opt/grafana
        - /opt/grafana-10.4.3
        - /var/lib/grafana

    - name: Fallback | Install systemd unit for grafana-server
      copy:
        dest: /etc/systemd/system/grafana-server.service
        mode: '0644'
        content: |
          [Unit]
          Description=Grafana Server (tarball)
          After=network.target

          [Service]
          Type=simple
          User=grafana
          Group=grafana
          ExecStart=/opt/grafana/bin/grafana-server --homepath /opt/grafana --config /etc/grafana/grafana.ini
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target

    - name: Fallback | Daemon-reload
      systemd:
        daemon_reload: yes

- name: Configure grafana.ini
  template: { src: templates/grafana.ini.j2, dest: /etc/grafana/grafana.ini }
  register: grafana_cfg

- name: Provision datasource
  copy: { src: files/provisioning/datasources/prometheus.yml, dest: /etc/grafana/provisioning/datasources/prometheus.yml }

- name: Provision dashboards
  copy: { src: files/provisioning/dashboards/dashboard.yml, dest: /etc/grafana/provisioning/dashboards/dashboard.yml }

- name: Ensure dashboards json dir
  file: { path: /etc/grafana/provisioning/dashboards/json, state: directory }

- name: Install basic dashboard
  copy: { src: files/provisioning/dashboards/json/basic.json, dest: /etc/grafana/provisioning/dashboards/json/basic.json }

- name: Enable and start grafana
  service: { name: grafana-server, state: started, enabled: yes }

- name: Restart grafana if config changed
  service: { name: grafana-server, state: restarted }
  when: grafana_cfg is changed
